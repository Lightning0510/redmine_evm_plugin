<%= form_tag({}) do -%>
<%= hidden_field_tag 'back_url', url_for(params), :id => nil %>
<div class="autoscroll">
<table class="list issues <%= sort_css_classes %>">
  <thead>
    <tr>
      <th class="checkbox hide-when-print">
        <%= check_box_tag 'check_all', '', false, :class => 'toggle-selection',
              :title => "#{l(:button_check_all)}/#{l(:button_uncheck_all)}" %>
      </th>
      <% query.inline_columns.each do |column| %>
        <%= column_header(column) %>
      <% end %>
      <th>BAC</th>
      <th>PV</th>
      <th>EV</th>
      <th>AV</th>
      <th>SV</th>
      <th>CV</th>
      <th>SPI</th>
      <th>CPI</th>
    </tr>
  </thead>
  <tbody>
  <% key_date, evm = @evmTotalHash.first %>
  <% grouped_issue_list(issues, @query, @issue_count_by_group) do |issue, level, group_name, group_count, group_totals| -%>
  <% if group_name %>
    <% reset_cycle %>
    <tr class="group open">
      <td colspan="<%= query.inline_columns.size + 9 %>">
        <span class="expander" onclick="toggleRowGroup(this);">&nbsp;</span>
        <span class="name"><%= group_name %></span>
        <%= link_to_function("#{l(:button_collapse_all)}/#{l(:button_expand_all)}",
                             "toggleAllRowGroups(this)", :class => 'toggle-all') %>
      </td>
    </tr>
  <% end %>
  <tr id="issue-<%= issue.id %>" class="hascontextmenu <%= cycle('odd', 'even') %> <%= issue.css_classes %> <%= level > 0 ? "idnt idnt-#{level}" : nil %>">
    <td class="checkbox hide-when-print"><%= check_box_tag("ids[]", issue.id, false, :id => nil) %></td>
    <%= raw query.inline_columns.map {|column| "<td class=\"#{column.css_classes}\">#{column_content(column, issue)}</td>"}.join %>
    <td class="tracker"><%=@list_evm[issue.id].bac %></td>
    <td class="tracker"><%=@list_evm[issue.id].pv %></td>
    <td class="tracker"><%=@list_evm[issue.id].ev %></td>
    <td class="tracker"><%=@list_evm[issue.id].av %></td>
    <td class="tracker"><%=@list_evm[issue.id].sv %></td>
    <td class="tracker"><%=@list_evm[issue.id].cv %></td>
    <td class="<%= (@list_evm[issue.id].spi.to_f < 0.8 && !(@list_evm[issue.id].spi == 'N/A')) ? 'red tracker' : 'tracker' %>"><%=@list_evm[issue.id].spi %></td>
    <td class="<%= (@list_evm[issue.id].cpi.to_f < 0.8 && !(@list_evm[issue.id].cpi == 'N/A')) ? 'red tracker' : 'tracker' %>"><%=@list_evm[issue.id].cpi %></td>
  </tr>
  <% @query.block_columns.each do |column|
       if (text = column_content(column, issue)) && text.present? -%>
  <tr class="<%= current_cycle %>">
    <td colspan="<%= @query.inline_columns.size + 9 %>" class="<%= column.css_classes %>"><%= text %></td>
  </tr>
  <% end -%>
  <% end -%>
  <% end -%>
  <tr class="hascontextmenu <%= cycle('odd', 'even') %> <%= @issues.first.css_classes %>">
    <% query.inline_columns.each_with_index do |column, index| %>
      <% break if index == query.inline_columns.length - 1 %>
      <td class=""></td>
    <% end %>
    <td class="bold">Total</td>
    <td class=""></td>
    <td class="tracker bold"><%= evm['bac'] %></td>
    <td class="tracker bold"><%= evm['pv'] %></td>
    <td class="tracker bold"><%= evm['ev'] %></td>
    <td class="tracker bold"><%= evm['av'] %></td>
    <td class="tracker bold"><%= evm['sv'] %></td>
    <td class="tracker bold"><%= evm['cv'] %></td>
    <td class="<%= ((evm['spi'].to_f < 0.8) && !(evm['spi'] == 'N/A')) ? 'red tracker bold' : 'tracker bold' %>"><%= evm['spi'] %></td>
    <td class="<%= ((evm['cpi'].to_f < 0.8) && !(evm['cpi'] == 'N/A')) ? 'red tracker bold' : 'tracker bold' %>"><%= evm['cpi'] %></td>
  </tr>
  </tbody>
</table>
</div>
<% end -%>
